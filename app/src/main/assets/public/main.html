<!DOCTYPE html>
<html lang="en">
<head>
  <title>Focus Media Korea Monitoring App</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../vendor/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="../vendor/jquery-confirm/dist/jquery-confirm.min.css">
  <script src="../vendor/jquery/jquery-3.1.1.min.js"></script>
  <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="../vendor/vue/vue.js"></script>
  <script src="../vendor/jquery-confirm/dist/jquery-confirm.min.js"></script>
  <script src="../vendor/common/common.js"></script>
</head>
<body>

<div class="container">
  <div id="main">
    <div>
      <button id="btnSync"> 동기화 </button>
      <button id="btnLogout"> 로그아웃 </button>
    </div>
    <div>
      <a href="noticeList.html"> [공지] 모니터링앱 튜토리얼 </a>
    </div>
    <div id="jobList">
      <ul>
        <li>
          <div class="list-item" style="cursor: pointer;">
            <p>송내 자이 아파트</p>
            <p>경기도 부천시 소사구 송내동 409</p>
            <p>[반려] 모니터링</p>
          </div>
        </li>
        <li>
          <div class="list-item" style="background:#efefef;cursor: pointer;">
            <p>송내 자이 아파트</p>
            <p>경기도 부천시 소사구 송내동 409</p>
            <p>[미완료] 모니터링</p>
          </div>
        </li>
      </ul>
    </div>
  </div>
</div>

</body>
</html>

<script language="javascript" type="text/javascript">
var agentCode = window.localStorage.getItem("agent_code");
var thisWeek = [];
$(document).ready(function(){
  callNative("hideToolBar");
  callNative("bottomActionBar", "jobStart");

  $('#btnSync').on('click', function() {
    // 데이터를 동기화하여 받는다.
    dataSync();
  });
  $('#btnLogout').on('click', function() {
    // 로그아웃한다.
    window.localStorage.setItem("agent_code", "");
    console.log(window.localStorage.getItem("agent_code"));
    location.href = "login.html";
  });
  $("#jobList .list-item").on('click', function() {
    // 모니터링/광고촬영 처리 리스트로 이동한다.
    location.href = "buildingJobProcessList.html";
  });

  getThisWeekDate();
});

function getThisWeekDate() {
  var currentDay = new Date();  
  var theYear = currentDay.getFullYear();
  var theMonth = currentDay.getMonth();
  var theDate  = currentDay.getDate();
  var theDayOfWeek = currentDay.getDay();
   
  for(var i=0; i<7; i++) {
    var resultDay = new Date(theYear, theMonth, theDate + (i - theDayOfWeek));
    var yyyy = resultDay.getFullYear();
    var mm = Number(resultDay.getMonth()) + 1;
    var dd = resultDay.getDate();
   
    mm = String(mm).length === 1 ? '0' + mm : mm;
    dd = String(dd).length === 1 ? '0' + dd : dd;
   
    thisWeek[i] = yyyy + '-' + mm + '-' + dd;
  }
}

function dataSync() {
  $.post('https://dev.treeter.net/fmksystem/Bmm_api/getRemoteVersion', {
    agent_code: agentCode,
    start_date: thisWeek[0],
    end_date: thisWeek[6]
  })
  .done(function(data) {
    var result = parseResult(data);
    //console.log(result.data);
    if (result.code == "success") {
      $.post('https://dev.treeter.net/fmksystem/Bmm_api/getUpdateDataList', {
        agent_code: agentCode,
        start_date: thisWeek[0],
        end_date: thisWeek[6],
        dataNames: 'notice,building,monitoring_request,ad_check_request,processing,code,as_request,as_processing'
      })
      .done(function(data) {
        var result = parseResult(data);
        console.log(result.data);
        
        let queryList = [];
        console.log(JSON.stringify(queryList));
        console.log(result.data.building.length);
        for(i=0;i<result.data.building.length;++i) {
          let currentData = result.data.building[i];
          queryList.push({"query": StringFormat("insert into building (building_id, building_name, machine_cnt, address) " + "values('{0}', '{1}', '{2}', '{3}')", currentData.building_id, currentData.building_name, currentData.machine_cnt, currentData.address)});
        }

        for(i=0;i<result.data.building_locate.length;++i) {
          let currentData = result.data.building_locate[i];
          queryList.push({"query": StringFormat("insert into building_locate (building_locate_id, building_id, dong, unit_name, machine_code, qr_serial_code) " + "values('{0}', '{1}', '{2}', '{3}', '{4}', '{5}')", currentData.building_locate_id, currentData.building_id, currentData.dong, currentData.unit_name, currentData.machine_code, currentData.qr_serial_code)});
        }
        console.log("encoded.... end");
        window.android.testFunc(JSON.stringify(queryList));
        if (result.code == "success") {
        } else {
          $.alert(result.data);
        }
      })
      .fail(function() {
        console.log('failed');
        $.alert("동기화에 실패하였습니다.\n인터넷연결상태를 확인해주세요.")
      });
    } else {
      $.alert(result.data);
    }
  })
  .fail(function() {
    console.log('failed');
    $.alert("동기화에 실패하였습니다.\n인터넷연결상태를 확인해주세요.")
  });
}

function qrScanResult(result) {
  // 모니터링, 광고촬영에 있는지 체크
  var qrCode = $.urlParam("cd", result);
  if (qrCode === null) {
    alert("인식이 불가능한 QR코드 입니다.");
    return;
  }
  window.localStorage.setItem("qr_code", qrCode);
  console.log(window.localStorage.getItem("qr_code"));
  location.href = "buildingJobList.html";
}

//아래 함수를 적절한 공용 라이브러리로 이동해주세요.
function StringFormat() {
    var expression = arguments[0]; 
    for (var i=1; i < arguments.length; i++) {
        var prttern = "{" + (i - 1) + "}"
        expression = expression.replace(prttern, arguments[i]);
    }

    return expression;
  }

</script>
